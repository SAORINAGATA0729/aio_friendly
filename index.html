<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIO改修マネージャー</title>
    <link rel="stylesheet" href="/css/styles.css?v=1.0.5">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <!-- Quill.js for Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase設定（MOLTSのGAアカウントで作成したFirebaseプロジェクト）
        const firebaseConfig = {
            apiKey: "AIzaSyAOAcJUHE_wumNG721vXE3xamSrrkxSEKI",
            authDomain: "giftee-60582.firebaseapp.com",
            projectId: "giftee-60582",
            storageBucket: "giftee-60582.firebasestorage.app",
            messagingSenderId: "734109990590",
            appId: "1:734109990590:web:22e03ddfd5485ab075a8ef",
            measurementId: "G-0MRZM6BHW6"
        };
        
        // Firebase設定が未設定の場合でもエラーを出さないようにする
        const isFirebaseConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY";
        
        if (isFirebaseConfigured) {
            try {
                import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js').then(({ initializeApp }) => {
                    return Promise.all([
                        import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js'),
                        import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js'),
                        Promise.resolve(initializeApp)
                    ]);
                }).then(([{ getAuth, GoogleAuthProvider }, { getFirestore }, initializeApp]) => {
                    // Firebase初期化
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    const googleProvider = new GoogleAuthProvider();
                    
                    // グローバルに公開
                    window.firebaseApp = app;
                    window.firebaseAuth = auth;
                    window.firebaseDb = db;
                    window.googleProvider = googleProvider;
                    
                    console.log('✅ Firebase初期化成功');
                }).catch((error) => {
                    console.warn('⚠️ Firebase初期化エラー（設定が未完了の可能性があります）:', error);
                    window.firebaseAuth = null;
                    window.firebaseDb = null;
                    window.googleProvider = null;
                });
            } catch (error) {
                console.warn('⚠️ Firebase SDK読み込みエラー:', error);
                window.firebaseAuth = null;
                window.firebaseDb = null;
                window.googleProvider = null;
            }
        } else {
            console.log('ℹ️ Firebase設定が未完了です。ログイン機能は無効です。');
            console.log('ℹ️ Firebase設定を完了すると、Googleログインと編集履歴機能が利用できます。');
            window.firebaseAuth = null;
            window.firebaseDb = null;
            window.googleProvider = null;
        }
    </script>
    <!-- docx.js for Word export - 動的インポートを使用 -->
    <!-- 注意: docx.jsはES6モジュール形式のため、グローバル変数として利用できません -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- ヘッダー -->
        <header class="app-header">
            <h1 class="app-title">
                <span class="material-icons-round">psychology</span>
                AIO改修マネージャー
            </h1>
            <div class="header-actions">
                <div id="authSection">
                    <button id="googleLoginBtn" class="btn btn-primary" style="display: none;">
                        <span class="material-icons-round">account_circle</span>
                        Googleでログイン
                    </button>
                    <div id="userInfo" style="display: none; align-items: center; gap: 0.5rem;">
                        <img id="userAvatar" src="" alt="" style="width: 32px; height: 32px; border-radius: 50%;">
                        <span id="userName" style="font-size: 0.9rem;"></span>
                        <button id="logoutBtn" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem;">
                            ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="main-content">
            <!-- PDCAタブ -->
            <div class="pdca-tabs">
                <button class="pdca-tab active" data-tab="plan">
                    <span class="material-icons-round">lightbulb</span>
                    Plan
                </button>
                <button class="pdca-tab" data-tab="do">
                    <span class="material-icons-round">edit</span>
                    Do
                </button>
                <button class="pdca-tab" data-tab="record">
                    <span class="material-icons-round">assessment</span>
                    Record
                </button>
                <button class="pdca-tab" data-tab="report">
                    <span class="material-icons-round">description</span>
                    Report
                </button>
            </div>

            <!-- Planタブコンテンツ -->
            <div id="planTab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Plan <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">プランニングシートを作る</span></h2>
                    <button id="createPlanBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons-round">add</span>
                        プランを作成する
                    </button>
                </div>
                
                <!-- プラン一覧 -->
                <div id="plansList" class="plans-list">
                    <!-- プランカードが動的に追加される -->
                </div>
            </div>

            <!-- Doタブコンテンツ -->
            <div id="doTab" class="tab-content">
                <h2>Do <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">施策実行 & リライト</span></h2>
                
                <!-- プラン選択セクション -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: 0.75rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem;">どのプランで記事の改修を進めますか？</label>
                    <select id="selectedPlanId" style="width: 100%; max-width: 500px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 0.9rem; background: white;">
                        <option value="">プランを選択してください</option>
                        <!-- プランが動的に追加される -->
                    </select>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                        <span class="material-icons-round" style="font-size: 14px; vertical-align: middle;">info</span>
                        プランを選択すると、そのプランで設定した記事URL一覧が表示されます。
                    </div>
                </div>
                
                <!-- 記事一覧 -->
                <div class="article-list-section">
                    <div class="section-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <h3>改修対象記事一覧</h3>
                            <div style="display: flex; align-items: center; gap: 1.5rem;">
                                <!-- 進捗状況 -->
                                <div style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.25rem;">
                                        <span style="font-size: 0.85rem; color: #6b7280;">完了</span>
                                        <span style="font-weight: 700; color: #059669;" id="progressCompleted">0</span>
                                        <span style="font-size: 0.75rem; color: #6b7280;">本</span>
                                    </div>
                                    <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
                                    <div style="display: flex; align-items: center; gap: 0.25rem;">
                                        <span style="font-size: 0.85rem; color: #6b7280;">進行中</span>
                                        <span style="font-weight: 700; color: #d97706;" id="progressInProgress">0</span>
                                        <span style="font-size: 0.75rem; color: #6b7280;">本</span>
                                    </div>
                                    <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
                                    <div style="display: flex; align-items: center; gap: 0.25rem;">
                                        <span style="font-size: 0.85rem; color: #6b7280;">未着手</span>
                                        <span style="font-weight: 700; color: #6b7280;" id="progressNotStarted">0</span>
                                        <span style="font-size: 0.75rem; color: #6b7280;">本</span>
                                    </div>
                                </div>
                                <div class="filter-buttons">
                                    <button class="filter-btn active" data-filter="all">すべて</button>
                                    <button class="filter-btn" data-filter="notStarted">未着手</button>
                                    <button class="filter-btn" data-filter="inProgress">進行中</button>
                                    <button class="filter-btn" data-filter="completed">完了</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="articleList" class="article-list">
                        <!-- 記事カードが動的に生成される -->
                    </div>
                </div>
            </div>

            <!-- Recordタブコンテンツ -->
            <div id="recordTab" class="tab-content">
                <h2>Record <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">検証 & モニタリング</span></h2>
                
                <!-- プラン選択 -->
                <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">プランニングシートを選択</label>
                    <select id="recordPlanSelect" style="width: 100%; max-width: 500px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 0.9rem; background: white;">
                        <option value="">プランを選択してください</option>
                    </select>
                </div>

                <!-- 計測日設定 -->
                <div class="monitoring-section" style="margin-bottom: 2rem;">
                    <h3>計測日設定</h3>
                    <form id="recordDateForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="publishDate">公開完了日 *</label>
                                <input type="datetime-local" id="publishDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="measurement2weeks">2週間後計測日</label>
                                <input type="datetime-local" id="measurement2weeks" class="form-input" readonly style="background: #f3f4f6;">
                            </div>
                            <div class="form-group">
                                <label for="measurement3weeks">3週間後計測日</label>
                                <input type="datetime-local" id="measurement3weeks" class="form-input" readonly style="background: #f3f4f6;">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- 数値入力セクション -->
                <div class="monitoring-section" id="recordMetricsSection" style="display: none;">
                    <h3>数値入力</h3>
                    
                    <!-- 現状数値（プランから引き継ぎ） -->
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f0f9ff; border-radius: 0.5rem; border: 1px solid #bfdbfe;">
                        <h4 style="margin: 0 0 1rem 0; font-size: 1rem; color: var(--text-primary); font-weight: 600;">現状数値（プランニングシートから引き継ぎ）</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">AIO引用数</label>
                                <input type="number" id="currentAioCitations" class="form-input" readonly style="background: #f3f4f6;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="currentAvgRanking" class="form-input" readonly style="background: #f3f4f6;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">トラフィック（クリック数）</label>
                                <input type="number" id="currentTraffic" class="form-input" readonly style="background: #f3f4f6;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">ブランド認知度</label>
                                <input type="number" id="currentBrandClicks" class="form-input" readonly style="background: #f3f4f6;">
                            </div>
                        </div>
                    </div>

                    <!-- 2週間後数値 -->
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; font-size: 1rem; color: var(--text-primary); font-weight: 600;">2週間後計測数値</h4>
                            <button type="button" id="import2weeksCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                CSVからインポート（全体数値）
                            </button>
                        </div>
                        <input type="file" id="csv2weeksFileInput" accept=".csv" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">AIO引用数</label>
                                <input type="number" id="metrics2weeksAioCitations" class="form-input">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="metrics2weeksAvgRanking" class="form-input">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">トラフィック（クリック数）</label>
                                <input type="number" id="metrics2weeksTraffic" class="form-input">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">ブランド認知度</label>
                                <input type="number" id="metrics2weeksBrandClicks" class="form-input">
                            </div>
                        </div>
                        
                        <!-- 2週間後記事ごとの数値入力テーブル -->
                        <div style="padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h5 style="margin: 0; font-size: 0.95rem; color: var(--text-primary); font-weight: 600;">記事ごとの数値入力（2週間後）</h5>
                                <button type="button" id="import2weeksArticleCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                    CSVからインポート
                                </button>
                            </div>
                            <input type="file" id="csv2weeksArticleFileInput" accept=".csv" style="display: none;">
                            <div style="overflow-x: auto;">
                                <table id="articleMetrics2weeksTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: #f9fafb; border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">記事名/URL</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">クリック数</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">表示回数</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">CTR (%)</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">順位</th>
                                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="articleMetrics2weeksBody">
                                        <!-- 動的に追加される -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 3週間後数値 -->
                    <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; font-size: 1rem; color: var(--text-primary); font-weight: 600;">3週間後計測数値</h4>
                            <button type="button" id="import3weeksCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                CSVからインポート（全体数値）
                            </button>
                        </div>
                        <input type="file" id="csv3weeksFileInput" accept=".csv" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">AIO引用数</label>
                                <input type="number" id="metrics3weeksAioCitations" class="form-input">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="metrics3weeksAvgRanking" class="form-input">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">トラフィック（クリック数）</label>
                                <input type="number" id="metrics3weeksTraffic" class="form-input">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">ブランド認知度</label>
                                <input type="number" id="metrics3weeksBrandClicks" class="form-input">
                            </div>
                        </div>
                        
                        <!-- 3週間後記事ごとの数値入力テーブル -->
                        <div style="padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h5 style="margin: 0; font-size: 0.95rem; color: var(--text-primary); font-weight: 600;">記事ごとの数値入力（3週間後）</h5>
                                <button type="button" id="import3weeksArticleCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                    CSVからインポート
                                </button>
                            </div>
                            <input type="file" id="csv3weeksArticleFileInput" accept=".csv" style="display: none;">
                            <div style="overflow-x: auto;">
                                <table id="articleMetrics3weeksTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: #f9fafb; border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">記事名/URL</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">クリック数</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">表示回数</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">CTR (%)</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">順位</th>
                                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="articleMetrics3weeksBody">
                                        <!-- 動的に追加される -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: right; margin-bottom: 2rem;">
                        <button type="button" id="saveRecordDataBtn" class="btn btn-primary">
                            <span class="material-icons-round">save</span>
                            データを保存
                        </button>
                    </div>
                </div>

                <!-- 結果表示セクション（Recordタブでは簡易表示のみ、詳細はReportタブへ） -->
                <div id="recordResultsSection" style="display: none; padding: 1.5rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; color: #166534;">
                    <p style="margin: 0; display: flex; align-items: center;">
                        <span class="material-icons-round" style="margin-right: 0.5rem;">check_circle</span>
                        データが保存されました。「Report」タブで詳細な分析結果を確認できます。
                    </p>
                </div>
            </div>

            <!-- Reportタブコンテンツ -->
            <div id="reportTab" class="tab-content">
                <h2>Report <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">レポート生成 & 分析</span></h2>
                
                <!-- プラン選択 -->
                <div class="form-group" style="margin-bottom: 2rem;">
                    <label for="reportPlanSelect">対象プランを選択</label>
                    <select id="reportPlanSelect" class="form-input" style="max-width: 500px;">
                        <option value="">プランを選択してください</option>
                    </select>
                </div>

                <!-- レポート表示エリア -->
                <div id="reportContent" style="display: none;">
                    <!-- エグゼクティブサマリー -->
                    <section id="executiveSummary" style="margin-bottom: 3rem;">
                        <h3>エグゼクティブサマリー</h3>
                        <div id="executiveSummaryContent" style="background: #f8f9fa; padding: 2rem; border-radius: 12px; border-left: 5px solid #3498db;">
                            <!-- AI推察が表示される -->
                        </div>
                    </section>

                    <!-- 数値結果 -->
                    <section id="metricsResults" style="margin-bottom: 3rem;">
                        <h3>数値結果</h3>
                        
                        <!-- 数値比較表 -->
                        <div id="metricsComparisonTable" style="margin-bottom: 2rem;">
                            <!-- 表が動的に生成される -->
                        </div>

                        <!-- 数値変化グラフ（2x2） -->
                        <div id="metricsCharts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div class="chart-container">
                                <canvas id="aioChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="rankingChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="trafficChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="brandChart"></canvas>
                            </div>
                        </div>
                    </section>

                    <!-- 記事ごとのパフォーマンス -->
                    <section id="articlePerformance" style="margin-bottom: 3rem;">
                        <h3>記事ごとのパフォーマンス</h3>
                        <div id="articlePerformanceTable">
                            <!-- 記事ごとのパフォーマンス表が動的に生成される -->
                        </div>
                    </section>

                    <!-- エクスポートボタン -->
                    <div id="reportExportActions" style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #e5e7eb; display: flex; justify-content: center; gap: 1rem;">
                        <button id="exportReportHtmlBtn" class="btn btn-secondary" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
                            <span class="material-icons-round">code</span>
                            HTMLでダウンロード
                        </button>
                        <button id="exportReportPdfBtn" class="btn btn-primary" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
                            <span class="material-icons-round">picture_as_pdf</span>
                            PDFでダウンロード
                        </button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- URL入力モーダル -->
    <div id="urlModal" class="modal">
        <div class="modal-content" style="max-width: 600px; height: auto;">
            <div class="modal-header">
                <h2>記事URLを入力</h2>
                <button class="modal-close" id="closeUrlModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="url-input-container">
                    <p style="margin-bottom: 1rem; color: #4b5563;">
                        編集する記事のURLを確認してください。
                    </p>
                    <div class="url-input-group">
                        <input type="text" id="articleUrlInput" class="form-input" placeholder="https://giftee.biz/columns/..." readonly>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                        <!-- 保存済みボタンは動的に追加される -->
                        
                        <!-- 自動取得ボタン -->
                        <button id="autoFetchBtn" class="btn btn-primary" style="padding: 1rem; font-size: 1.1rem; justify-content: center; background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);">
                            <span class="material-icons-round">auto_fix_high</span>
                            記事内容を自動取得して編集
                        </button>
                        
                        <!-- 「または」のdiv（保存済みがない場合は非表示） -->
                        <div class="or-divider" style="position: relative; text-align: center; margin: 10px 0; display: none;">
                            <span style="background: #f8fafc; padding: 0 10px; color: #6b7280; font-size: 0.9rem; position: relative; z-index: 1;">または</span>
                            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #e5e7eb; z-index: 0;"></div>
                        </div>

                        <!-- 手動用ボタン（非表示にする） -->
                        <div style="display: none;">
                            <button id="openUrlBtn" class="btn btn-secondary" style="flex: 1; color: var(--text-primary); border-color: var(--border-color); background: white;">
                                <span class="material-icons-round">open_in_new</span>
                                ブラウザで開く
                            </button>
                            <button id="proceedToEditorBtn" class="btn btn-secondary" style="flex: 1; color: var(--text-primary); border-color: var(--border-color); background: white;">
                                <span class="material-icons-round">edit_note</span>
                                空のエディタを開く
                            </button>
                        </div>
                    </div>

                    <div id="fetchStatus" style="margin-top: 15px; font-size: 0.9rem; min-height: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- プラン作成/編集モーダル -->
    <div id="planModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="planModalTitle">プランを作成</h2>
                <button class="modal-close" id="closePlanModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <!-- プラン名 -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">プラン名 *</label>
                        <input type="text" id="planName" required 
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="例: Tier 1 記事改修プラン">
                    </div>
                    
                    <!-- 目的 -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">目的 *</label>
                        <textarea id="planObjective" required rows="3"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="このプランの目的を記入してください"></textarea>
                    </div>
                    
                    <!-- 概要 -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">概要</label>
                        <textarea id="planOverview" rows="4"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="プランの概要を記入してください"></textarea>
                    </div>
                    
                    <!-- 現状数値の把握セクション -->
                    <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 1.5rem 0; font-size: 1.2rem; color: var(--text-primary); font-weight: 600;">現状数値の把握</h3>
                        
                        <!-- AIOとかの数値 -->
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="margin: 0; font-size: 1rem; color: var(--text-primary); font-weight: 600;">AIOとかの数値</h4>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <!-- CSVインポートボタン -->
                                <button type="button" id="importCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                    CSVからインポート
                                </button>
                                <!-- MDインポートボタン -->
                                <button type="button" id="importMdMetricsBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">description</span>
                                    MDからインポート
                                </button>
                                <!-- CSVエクスポートボタン（テンプレートダウンロード用） -->
                                <button type="button" id="exportCsvTemplateBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">download</span>
                                    テンプレート
                                </button>
                            </div>
                        </div>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        <input type="file" id="mdMetricsFileInput" accept=".md,.txt" style="display: none;">
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; flex-direction: column;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">AIO引用数</label>
                                <input type="number" id="planAioCitations" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="857">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="planAvgRanking" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="4.88">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">トラフィック（クリック数）</label>
                                <input type="number" id="planTraffic" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="102000">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">ブランド認知度</label>
                                <input type="number" id="planBrandClicks" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="22">
                            </div>
                            </div>
                        </div>
                        
                        <!-- 記事ごとの数値入力テーブル -->
                        <div style="padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="margin: 0; font-size: 1rem; color: var(--text-primary); font-weight: 600;">記事ごとの数値入力</h4>
                                <div style="display: flex; gap: 0.5rem;">
                                    <!-- CSVインポートボタン -->
                                    <button type="button" id="importArticleMetricsCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                        <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                        CSVからインポート
                                    </button>
                                    <!-- MDインポートボタン -->
                                    <button type="button" id="importArticleMetricsMdBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                        <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">description</span>
                                        MDからインポート
                                    </button>
                                    <button type="button" id="addArticleRowBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                        <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">add</span>
                                        記事を追加
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="articleMetricsCsvFileInput" accept=".csv" style="display: none;">
                            <input type="file" id="articleMetricsMdFileInput" accept=".md,.txt" style="display: none;">
                            <div style="overflow-x: auto;">
                                <table id="articleMetricsTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: #f9fafb; border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">記事名/URL</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">クリック数</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">表示回数</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">CTR (%)</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">順位</th>
                                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="articleMetricsBody">
                                        <!-- 動的に追加される -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- API連携ボタン（将来実装用） -->
                        <button type="button" id="connectAhrefsBtn" class="btn btn-secondary" 
                            style="width: 100%; margin-top: 0.5rem; opacity: 0.6; cursor: not-allowed;"
                            disabled title="Ahrefs API連携は今後実装予定">
                            <span class="material-icons-round" style="margin-right: 4px;">link</span>
                            Ahrefs API連携（今後実装予定）
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" id="cancelPlanBtn" class="btn btn-secondary">キャンセル</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ベースライン編集モーダル -->
    <div id="baselineModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ベースライン設定（2025年12月実績）</h2>
                <button class="modal-close" id="closeBaselineModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="baselineForm">
                    <!-- 数値入力 -->
                    <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 1rem; font-size: 1.1rem; color: var(--text-primary);">全体数値</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">AIO引用数</label>
                                <input type="number" id="baselineAioCitations" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="857">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="baselineAvgRanking" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="4.88">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">トラフィック（クリック数）</label>
                                <input type="number" id="baselineTraffic" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="102000">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">ブランド認知度</label>
                                <input type="number" id="baselineBrandClicks" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="22">
                            </div>
                        </div>
                    </div>

                    <!-- Tier 1記事詳細データ入力 -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem; font-size: 1.1rem; color: var(--text-primary);">Tier 1記事詳細データ</h3>
                        <div id="tier1ArticlesInputContainer" style="overflow-x: auto;">
                            <!-- テーブルが動的に生成される -->
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('baselineModal').classList.remove('active')">キャンセル</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- エビデンス追加モーダル -->
    <div id="evidenceModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>月次データを追加</h2>
                <button class="modal-close" onclick="document.getElementById('evidenceModal').classList.remove('active')">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="evidenceForm">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">対象月</label>
                        <input type="month" id="evidenceMonth" required
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;">
                    </div>

                    <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 1rem; font-size: 1.1rem; color: var(--text-primary);">実績数値</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">AIO引用数</label>
                                <input type="number" id="evidenceAioCitations" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="evidenceAvgRanking" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">トラフィック</label>
                                <input type="number" id="evidenceTraffic" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">ブランド認知度</label>
                                <input type="number" id="evidenceBrandClicks" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">備考</label>
                        <textarea id="evidenceNotes" rows="3"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="特記事項があれば記入してください"></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('evidenceModal').classList.remove('active')">キャンセル</button>
                        <button type="button" class="btn btn-primary" onclick="dashboardSystem.saveEvidenceRecord()">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- リライトモーダル -->
    <div id="rewriteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="rewriteModalTitle">記事リライト</h2>
                <button class="modal-close" id="closeRewriteModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="rewrite-container">
                    <div class="rewrite-sidebar">
                        <!-- AIOスコア表示 -->
                        <div id="checklistScore" class="checklist-score">
                            <!-- スコアとランクが動的に生成される -->
                        </div>
                        <div class="improvement-section">
                            <h4 class="improvement-title accordion-header" id="improvementAccordionHeader">
                                <span>AIO改善項目</span>
                                <span class="material-icons-round accordion-icon">expand_more</span>
                            </h4>
                            <div id="checklistItems" class="checklist-items accordion-content">
                                <!-- チェックリスト項目が動的に生成される -->
                            </div>
                        </div>
                    </div>
                    <div class="rewrite-editor">
                        <div class="editor-toolbar">
                            <!-- 編集モード切り替えタブ -->
                            <div class="editor-mode-tabs">
                                <button class="mode-tab active" data-mode="visual" id="visualModeTab">
                                    <span class="material-icons-round">visibility</span>
                                    ビジュアル
                                </button>
                                <button class="mode-tab" data-mode="html" id="htmlModeTab">
                                    <span class="material-icons-round">code</span>
                                    HTML
                                </button>
                            </div>
                            <div style="flex: 1;"></div>
                            <!-- 検索バー -->
                            <div id="searchBar" class="search-bar" style="display: none;">
                                <input type="text" id="searchInput" class="search-input" placeholder="検索...">
                                <button id="searchPrevBtn" class="search-nav-btn" title="前へ">
                                    <span class="material-icons-round">arrow_upward</span>
                                </button>
                                <button id="searchNextBtn" class="search-nav-btn" title="次へ">
                                    <span class="material-icons-round">arrow_downward</span>
                                </button>
                                <span id="searchCount" class="search-count"></span>
                                <button id="searchCloseBtn" class="search-close-btn" title="閉じる">
                                    <span class="material-icons-round">close</span>
                                </button>
                            </div>
                            <div class="toolbar-group">
                                <button class="toolbar-btn" id="searchToggleBtn" title="検索 (⌘F)">
                                    <span class="material-icons-round">search</span>
                                    検索
                                </button>
                                <button class="toolbar-btn" id="previewBtn" title="プレビュー">
                                    <span class="material-icons-round">preview</span>
                                    プレビュー
                                </button>
                                <button class="toolbar-btn" data-action="export" id="rewriteExportBtn">
                                    <span class="material-icons-round">download</span>
                                    ダウンロード
                                </button>
                                <button class="toolbar-btn primary" data-action="save">
                                    <span class="material-icons-round">save</span>
                                    保存
                                </button>
                            </div>
                        </div>
                        <!-- ビジュアルモード（Quill Rich Text Editor） -->
                        <div id="visualEditorContainer" class="editor-mode-container active">
                            <!-- 編集モード切り替え（通常編集｜提案モード） -->
                            <div class="edit-mode-tabs" id="editModeTabs" style="display: none; margin-bottom: 0.75rem;">
                                <button class="edit-mode-tab active" data-edit-mode="normal" id="normalEditTab">
                                    <span class="material-icons-round">edit</span>
                                    通常編集
                                </button>
                                <button class="edit-mode-tab" data-edit-mode="suggestion" id="suggestionEditTab">
                                    <span class="material-icons-round">rate_review</span>
                                    提案モード
                                </button>
                            </div>
                            <div id="quillEditor" style="background: white; border-radius: 8px;"></div>
                        </div>
                        <!-- HTMLモード（テキストエディタ） -->
                        <div id="htmlEditorContainer" class="editor-mode-container">
                            <textarea id="htmlEditor" class="html-editor" placeholder="HTML形式で記事を編集してください..."></textarea>
                        </div>
                        <!-- Hidden textarea for storing content -->
                        <textarea id="markdownEditor" style="display: none;"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 提案モード用フロートボタン（下部固定） -->
    <div id="suggestionFloatButtons" class="suggestion-float-buttons" style="display: none;">
        <!-- 変更履歴エリア（アコーディオン） -->
        <div id="suggestionCommentHistory" class="suggestion-comment-history">
            <div class="comment-history-header" onclick="window.rewriteSystem.toggleChangeHistory()">
                <span class="material-icons-round comment-history-expand-icon" style="font-size: 18px; transition: transform 0.2s;">expand_more</span>
                <span class="material-icons-round">history</span>
                <span>変更履歴</span>
            </div>
            <div id="commentHistoryList" class="comment-history-list">
                <!-- 変更履歴が動的に追加される -->
            </div>
        </div>
        
        <!-- フロートボタン -->
        <button class="float-btn float-btn-deletion" id="floatDeletionBtn" title="選択範囲を削除マーカー化（Ctrl+Shift+D）">
            <span class="material-icons-round">strikethrough_s</span>
            <span class="float-btn-label">削除</span>
        </button>
        <button class="float-btn float-btn-comment" id="floatCommentBtn" title="選択範囲にコメントを追加">
            <span class="material-icons-round">comment</span>
            <span class="float-btn-label">コメント追加</span>
        </button>
    </div>

    <!-- エクスポートモーダル -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>エクスポート</h2>
                <button class="modal-close" id="closeExportModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: #4b5563;">
                    記事を以下の形式でダウンロードできます。
                </p>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="export-option-btn" data-format="pdf">
                        <span class="material-icons-round">picture_as_pdf</span>
                        <div>
                            <div style="font-weight: 600;">PDF形式</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">PDFファイルとしてダウンロード</div>
                        </div>
                    </button>
                    <button class="export-option-btn" data-format="docx">
                        <span class="material-icons-round">description</span>
                        <div>
                            <div style="font-weight: 600;">Word形式 (.docx)</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Microsoft Wordで開ける形式</div>
                        </div>
                    </button>
                    <button class="export-option-btn" data-format="html">
                        <span class="material-icons-round">code</span>
                        <div>
                            <div style="font-weight: 600;">HTML形式</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Googleドキュメントにインポート可能</div>
                        </div>
                    </button>
                    <button class="export-option-btn" data-format="md">
                        <span class="material-icons-round">article</span>
                        <div>
                            <div style="font-weight: 600;">Markdown形式 (.md)</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Markdownファイルとしてダウンロード</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- プレビューモーダル -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>プレビュー</h2>
                <button class="modal-close" id="closePreviewModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 2rem;">
                <div id="previewContent" style="
                    max-width: 800px;
                    margin: 0 auto;
                    background: white;
                    padding: 2rem;
                    border-radius: 8px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    line-height: 1.8;
                    color: #1f2937;
                ">
                    <!-- プレビュー内容がここに表示されます -->
                </div>
            </div>
        </div>
    </div>

    <!-- スクリプト -->
    <script src="/js/data-manager.js?v=1.0.4"></script>
    <script src="/js/toast.js?v=1.0.0"></script>
    <script src="/js/auth.js?v=1.0.0"></script>
    <script src="/js/edit-history.js?v=1.0.0"></script>
    <script src="/js/suggestion-ui.js?v=1.0.0"></script>
    <script src="/js/dashboard.js?v=1.0.4"></script>
    <script src="/js/rewrite.js?v=1.0.4" onerror="window.rewriteJsLoadError = true; console.error('❌ rewrite.jsの読み込みに失敗しました');"></script>
    <script src="/js/monitoring.js?v=1.0.4"></script>
    <script src="/js/reporting.js?v=1.0.4"></script>
    
    <!-- 初期化 -->
    <script>
        // #region agent log
        const cssLink = document.querySelector('link[href*="styles.css"]');
        const jsScripts = Array.from(document.querySelectorAll('script[src]')).map(s => s.src);
        fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:525',message:'Script loading check - Before DOMContentLoaded',data:{cssHref:cssLink?.href,jsScripts:jsScripts,Dashboard:typeof Dashboard,RewriteSystem:typeof RewriteSystem,MonitoringSystem:typeof MonitoringSystem,ReportingSystem:typeof ReportingSystem,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        
        // グローバル変数としてインスタンスを作成（windowオブジェクトに直接代入）
        window.dashboard = null;
        window.rewriteSystem = null;
        window.monitoringSystem = null;
        window.reportingSystem = null;

        // スクリプトが読み込まれるまで待つ関数
        async function waitForScripts(maxWaitTime = 10000) {
            const startTime = Date.now();
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:535',message:'waitForScripts: Starting wait',data:{maxWaitTime:maxWaitTime},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'B'})}).catch(()=>{});
            // #endregion
            
            while (Date.now() - startTime < maxWaitTime) {
                const elapsed = Date.now() - startTime;
                const DashboardDefined = typeof Dashboard !== 'undefined';
                const RewriteSystemDefined = typeof RewriteSystem !== 'undefined';
                const MonitoringSystemDefined = typeof MonitoringSystem !== 'undefined';
                const ReportingSystemDefined = typeof ReportingSystem !== 'undefined';
                
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:545',message:'waitForScripts: Checking script availability',data:{elapsed:elapsed,DashboardDefined:DashboardDefined,RewriteSystemDefined:RewriteSystemDefined,MonitoringSystemDefined:MonitoringSystemDefined,ReportingSystemDefined:ReportingSystemDefined,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'C'})}).catch(()=>{});
                // #endregion
                
                if (DashboardDefined && RewriteSystemDefined && MonitoringSystemDefined && ReportingSystemDefined) {
                    // #region agent log
                    fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:550',message:'waitForScripts: All scripts loaded',data:{elapsed:elapsed},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'D'})}).catch(()=>{});
                    // #endregion
                    console.log('✅ すべてのスクリプトが読み込まれました');
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:560',message:'waitForScripts: Timeout',data:{elapsed:Date.now()-startTime,DashboardDefined:typeof Dashboard !== 'undefined',RewriteSystemDefined:typeof RewriteSystem !== 'undefined',MonitoringSystemDefined:typeof MonitoringSystem !== 'undefined',ReportingSystemDefined:typeof ReportingSystem !== 'undefined',rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'E'})}).catch(()=>{});
            // #endregion
            return false;
        }

        // DOMContentLoaded後に初期化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:565',message:'DOMContentLoaded: Starting initialization',data:{Dashboard:typeof Dashboard,RewriteSystem:typeof RewriteSystem,MonitoringSystem:typeof MonitoringSystem,ReportingSystem:typeof ReportingSystem,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'F'})}).catch(()=>{});
                // #endregion
                
                console.log('システムの初期化を開始します...');
                
                // スクリプトが読み込まれるまで待つ
                console.log('スクリプトの読み込みを待機中...');
                const scriptsLoaded = await waitForScripts();
                
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:575',message:'DOMContentLoaded: After waitForScripts',data:{scriptsLoaded:scriptsLoaded,Dashboard:typeof Dashboard,RewriteSystem:typeof RewriteSystem,MonitoringSystem:typeof MonitoringSystem,ReportingSystem:typeof ReportingSystem,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'G'})}).catch(()=>{});
                // #endregion
                
                if (!scriptsLoaded) {
                    const missingScripts = [];
                    if (typeof Dashboard === 'undefined') missingScripts.push('Dashboard (js/dashboard.js)');
                    if (typeof RewriteSystem === 'undefined') missingScripts.push('RewriteSystem (js/rewrite.js)');
                    if (typeof MonitoringSystem === 'undefined') missingScripts.push('MonitoringSystem (js/monitoring.js)');
                    if (typeof ReportingSystem === 'undefined') missingScripts.push('ReportingSystem (js/reporting.js)');
                    
                    // #region agent log
                    fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:585',message:'DOMContentLoaded: Scripts not loaded error',data:{missingScripts:missingScripts,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H'})}).catch(()=>{});
                    // #endregion
                    
                    throw new Error('以下のスクリプトが読み込まれていません: ' + missingScripts.join(', '));
                }
                
                // 各システムのインスタンスを作成
                window.dashboard = new Dashboard();
                window.rewriteSystem = new RewriteSystem();
                window.monitoringSystem = new MonitoringSystem();
                window.reportingSystem = new ReportingSystem();
                
                // 初期化を順番に実行（rewriteSystemを先に初期化してからdashboardを初期化）
                console.log('RewriteSystemの初期化を開始...');
                await window.rewriteSystem.init();
                console.log('RewriteSystemの初期化が完了しました');
                
                console.log('Dashboardの初期化を待機中...');
                await window.dashboard.init();
                console.log('Dashboardの初期化が完了しました');
                
                console.log('MonitoringSystemの初期化を開始...');
                await window.monitoringSystem.init();
                console.log('MonitoringSystemの初期化が完了しました');
                
                console.log('ReportingSystemの初期化を開始...');
                await window.reportingSystem.init();
                console.log('ReportingSystemの初期化が完了しました');
                
                console.log('✅ すべてのシステムの初期化が完了しました');
            } catch (error) {
                console.error('❌ システムの初期化エラー:', error);
                alert('システムの初期化に失敗しました。ページをリロードしてください。\nエラー: ' + error.message);
            }
        });
    </script>
</body>
</html>
