<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIO_PDCA爆速システム</title>
    <link rel="stylesheet" href="/css/styles.css?v=1.0.1">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <!-- Quill.js for Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- docx.js for Word export -->
    <!-- UMDビルドを使用してグローバル変数として利用可能にする -->
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.js" type="module"></script>
    <script>
        // docx.jsがグローバル変数として利用可能か確認
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('docx.js check:', {
                    'typeof docx': typeof docx,
                    'typeof window.docx': typeof window.docx,
                    'window.docx': window.docx
                });
                if (typeof docx === 'undefined' && typeof window.docx === 'undefined') {
                    console.warn('docx.jsが読み込まれていません。別のCDNを試します...');
                    // フォールバック: unpkgのUMDビルドを試す
                    const script = document.createElement('script');
                    script.src = 'https://unpkg.com/docx@8.5.0/build/index.js';
                    script.onload = () => {
                        console.log('docx.js (unpkg) loaded:', typeof docx, typeof window.docx);
                    };
                    script.onerror = () => {
                        console.error('docx.jsの読み込みに失敗しました');
                    };
                    document.head.appendChild(script);
                } else {
                    console.log('docx.jsが読み込まれました');
                }
            }, 1000);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- ヘッダー -->
        <header class="app-header">
            <h1 class="app-title">
                <span class="material-icons-round">psychology</span>
                AIO_PDCA爆速システム
            </h1>
            <div class="header-actions">
                <button id="backupBtn" class="btn btn-secondary">
                    <span class="material-icons-round">backup</span>
                    バックアップ
                </button>
                <button id="exportBtn" class="btn btn-secondary">
                    <span class="material-icons-round">download</span>
                    エクスポート
                </button>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="main-content">
            <!-- PDCAタブ -->
            <div class="pdca-tabs">
                <button class="pdca-tab active" data-tab="plan">
                    <span class="material-icons-round">lightbulb</span>
                    Plan
                </button>
                <button class="pdca-tab" data-tab="do">
                    <span class="material-icons-round">edit</span>
                    Do
                </button>
                <button class="pdca-tab" data-tab="check">
                    <span class="material-icons-round">assessment</span>
                    Check
                </button>
                <button class="pdca-tab" data-tab="action">
                    <span class="material-icons-round">trending_up</span>
                    Action
                </button>
            </div>

            <!-- Planタブコンテンツ -->
            <div id="planTab" class="tab-content active">
                <h2>Plan <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">仮説立案 & 現状把握</span></h2>
                
                <!-- 現状把握カード -->
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="material-icons-round">search</span>
                            <h3>AIO引用数</h3>
                        </div>
                        <div class="card-body">
                            <div class="metric-value" id="aioCitationCount">857</div>
                            <div class="metric-label">件（目標: 1,200件以上）</div>
                            <div class="metric-change" id="aioCitationChange">+0件</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="material-icons-round">trending_up</span>
                            <h3>検索順位（Tier 1）</h3>
                        </div>
                        <div class="card-body">
                            <div class="metric-value" id="searchRankingAvg">4.88</div>
                            <div class="metric-label">位（目標: 5.0位以下）</div>
                            <div class="metric-change" id="searchRankingChange">±0位</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="material-icons-round">bar_chart</span>
                            <h3>トラフィック</h3>
                        </div>
                        <div class="card-body">
                            <div class="metric-value" id="trafficClicks">102,000</div>
                            <div class="metric-label">クリック数（12月）</div>
                            <div class="metric-change" id="trafficChange">+0件</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="material-icons-round">visibility</span>
                            <h3>ブランド認知度</h3>
                        </div>
                        <div class="card-body">
                            <div class="metric-value" id="brandClicks">22</div>
                            <div class="metric-label">クリック数（12月）</div>
                            <div class="metric-change" id="brandChange">+0件</div>
                        </div>
                    </div>
                </div>

                <!-- 進捗状況 -->
                <div class="progress-section">
                    <h3>改修進捗状況</h3>
                    <div class="progress-summary">
                        <div class="progress-item">
                            <span class="progress-label">完了</span>
                            <div>
                                <span class="progress-value" id="progressCompleted">0</span>
                                <span class="progress-unit">本</span>
                            </div>
                        </div>
                        <div class="progress-item">
                            <span class="progress-label">進行中</span>
                            <div>
                                <span class="progress-value" id="progressInProgress">0</span>
                                <span class="progress-unit">本</span>
                            </div>
                        </div>
                        <div class="progress-item">
                            <span class="progress-label">未着手</span>
                            <div>
                                <span class="progress-value" id="progressNotStarted">20</span>
                                <span class="progress-unit">本</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 仮説立案フォーム -->
                <div class="hypothesis-section" style="background: white; border-radius: 1rem; padding: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
                    <h3>仮説立案</h3>
                    <form id="hypothesisForm">
                        <div class="form-group">
                            <label for="hypothesisTitle">仮説タイトル</label>
                            <input type="text" id="hypothesisTitle" class="form-input" placeholder="例: Tier 1の20ページをAIフレンドリー化することで、AIO引用数を40%向上させる">
                        </div>
                        <div class="form-group">
                            <label for="hypothesisDescription">仮説の詳細</label>
                            <textarea id="hypothesisDescription" class="form-textarea" rows="5" placeholder="仮説の背景、期待される効果、実施方法などを記述してください"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="hypothesisTarget">目標指標</label>
                            <input type="text" id="hypothesisTarget" class="form-input" placeholder="例: AIO引用数 857件 → 1,200件以上">
                        </div>
                        <div style="text-align: right;">
                            <button type="submit" class="btn btn-primary">
                                <span class="material-icons-round">save</span>
                                仮説を保存
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Doタブコンテンツ -->
            <div id="doTab" class="tab-content">
                <h2>Do <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">施策実行 & リライト</span></h2>
                
                <!-- 記事一覧 -->
                <div class="article-list-section">
                    <div class="section-header">
                        <h3>改修対象記事一覧（Tier 1の20ページ）</h3>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">すべて</button>
                            <button class="filter-btn" data-filter="notStarted">未着手</button>
                            <button class="filter-btn" data-filter="inProgress">進行中</button>
                            <button class="filter-btn" data-filter="completed">完了</button>
                        </div>
                    </div>
                    <div id="articleList" class="article-list">
                        <!-- 記事カードが動的に生成される -->
                    </div>
                </div>
            </div>

            <!-- Checkタブコンテンツ -->
            <div id="checkTab" class="tab-content">
                <h2>Check <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">検証 & モニタリング</span></h2>
                
                <!-- モニタリングデータ入力 -->
                <div class="monitoring-section">
                    <h3>モニタリングデータ入力</h3>
                    <form id="monitoringForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="monitoringMonth">対象月</label>
                                <input type="month" id="monitoringMonth" class="form-input" required>
                            </div>
                        </div>

                        <div class="monitoring-category">
                            <h4><span class="material-icons-round">search</span> AIO引用数（Ahrefs）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Google AI Overview</label>
                                    <input type="number" class="form-input" data-metric="aio_google" placeholder="件数">
                                </div>
                                <div class="form-group">
                                    <label>ChatGPT</label>
                                    <input type="number" class="form-input" data-metric="aio_chatgpt" placeholder="件数">
                                </div>
                                <div class="form-group">
                                    <label>Perplexity</label>
                                    <input type="number" class="form-input" data-metric="aio_perplexity" placeholder="件数">
                                </div>
                            </div>
                        </div>

                        <div class="monitoring-category">
                            <h4><span class="material-icons-round">trending_up</span> 検索順位（Tier 1の20ページ）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>合計クリック数</label>
                                    <input type="number" class="form-input" data-metric="ranking_clicks" placeholder="クリック数">
                                </div>
                                <div class="form-group">
                                    <label>平均掲載順位</label>
                                    <input type="number" step="0.01" class="form-input" data-metric="ranking_position" placeholder="順位">
                                </div>
                            </div>
                        </div>

                        <div class="monitoring-category">
                            <h4><span class="material-icons-round">bar_chart</span> トラフィック分析（全体）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>総クリック数</label>
                                    <input type="number" class="form-input" data-metric="traffic_clicks" placeholder="クリック数">
                                </div>
                                <div class="form-group">
                                    <label>平均CTR</label>
                                    <input type="number" step="0.01" class="form-input" data-metric="traffic_ctr" placeholder="%">
                                </div>
                            </div>
                        </div>

                        <div class="monitoring-category">
                            <h4><span class="material-icons-round">visibility</span> ブランド認知度（指名検索）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>合計クリック数</label>
                                    <input type="number" class="form-input" data-metric="brand_clicks" placeholder="クリック数">
                                </div>
                                <div class="form-group">
                                    <label>平均順位</label>
                                    <input type="number" step="0.01" class="form-input" data-metric="brand_position" placeholder="順位">
                                </div>
                            </div>
                        </div>

                        <div style="text-align: right;">
                            <button type="submit" class="btn btn-primary">
                                <span class="material-icons-round">save</span>
                                データを保存
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 前後比較グラフ -->
                <div class="comparison-section">
                    <h3>前後比較グラフ</h3>
                    <div class="chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Actionタブコンテンツ -->
            <div id="actionTab" class="tab-content">
                <h2>Action <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">振り返り & レポート</span></h2>
                
                <!-- 効果測定結果 -->
                <div class="results-section">
                    <h3>効果測定結果</h3>
                    <div id="resultsSummary" class="results-summary">
                        <!-- 結果が動的に生成される -->
                    </div>
                </div>

                <!-- 改善提案 -->
                <div class="improvement-section">
                    <h3>改善提案</h3>
                    <form id="improvementForm">
                        <div class="form-group">
                            <label for="improvementTitle">改善タイトル</label>
                            <input type="text" id="improvementTitle" class="form-input" placeholder="例: 表の活用を増やす">
                        </div>
                        <div class="form-group">
                            <label for="improvementDescription">改善内容</label>
                            <textarea id="improvementDescription" class="form-textarea" rows="5" placeholder="具体的な改善内容を記述してください"></textarea>
                        </div>
                        <div style="text-align: right;">
                            <button type="submit" class="btn btn-primary">
                                <span class="material-icons-round">save</span>
                                改善提案を保存
                            </button>
                        </div>
                    </form>
                </div>

                <!-- レポート生成 -->
                <div class="report-section">
                    <h3>レポート生成</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="generateReportBtn" class="btn btn-primary">
                            <span class="material-icons-round">description</span>
                            レポートを生成
                        </button>
                        <button id="exportPdfBtn" class="btn btn-secondary" style="color: var(--text-primary);">
                            <span class="material-icons-round">picture_as_pdf</span>
                            PDFでダウンロード
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- URL入力モーダル -->
    <div id="urlModal" class="modal">
        <div class="modal-content" style="max-width: 600px; height: auto;">
            <div class="modal-header">
                <h2>記事URLを入力</h2>
                <button class="modal-close" id="closeUrlModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="url-input-container">
                    <p style="margin-bottom: 1rem; color: #4b5563;">
                        編集する記事のURLを確認してください。
                    </p>
                    <div class="url-input-group">
                        <input type="text" id="articleUrlInput" class="form-input" placeholder="https://giftee.biz/columns/..." readonly>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                        <!-- 自動取得ボタン -->
                        <button id="autoFetchBtn" class="btn btn-primary" style="padding: 1rem; font-size: 1.1rem; justify-content: center; background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);">
                            <span class="material-icons-round">auto_fix_high</span>
                            記事内容を自動取得して編集
                        </button>
                        
                        <div style="position: relative; text-align: center; margin: 10px 0;">
                            <span style="background: #f8fafc; padding: 0 10px; color: #6b7280; font-size: 0.9rem; position: relative; z-index: 1;">または</span>
                            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #e5e7eb; z-index: 0;"></div>
                        </div>

                        <!-- 手動用ボタン -->
                        <div style="display: flex; gap: 10px;">
                            <button id="openUrlBtn" class="btn btn-secondary" style="flex: 1; color: var(--text-primary); border-color: var(--border-color); background: white;">
                                <span class="material-icons-round">open_in_new</span>
                                ブラウザで開く
                            </button>
                            <button id="proceedToEditorBtn" class="btn btn-secondary" style="flex: 1; color: var(--text-primary); border-color: var(--border-color); background: white;">
                                <span class="material-icons-round">edit_note</span>
                                空のエディタを開く
                            </button>
                        </div>
                    </div>

                    <div id="fetchStatus" style="margin-top: 15px; font-size: 0.9rem; min-height: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- リライトモーダル -->
    <div id="rewriteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="rewriteModalTitle">記事リライト</h2>
                <button class="modal-close" id="closeRewriteModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="rewrite-container">
                    <div class="rewrite-sidebar">
                        <h3>チェックリスト</h3>
                        <!-- スコア表示エリア -->
                        <div id="checklistScore" class="checklist-score">
                            <div class="score-status">
                                <div class="score-main">
                                    <span class="score-label">現状：</span>
                                    <span id="scoreNumber">0</span>
                                    <span class="score-unit">点</span>
                                    <span class="score-separator">/</span>
                                    <span class="score-total">100点</span>
                                </div>
                                <div class="score-rank-display">
                                    <span class="rank-label">ランク</span>
                                    <span id="scoreRank" class="rank-value">-</span>
                                </div>
                            </div>
                            <div class="score-progress">
                                <div class="score-bar">
                                    <div class="score-bar-fill" id="scoreBarFill" style="width: 0%"></div>
                                </div>
                                <div class="score-text">
                                    <span id="checkedCount">0</span> / <span id="totalCount">0</span> 項目
                                </div>
                            </div>
                        </div>
                        <div class="improvement-section">
                            <h4 class="improvement-title">改善項目</h4>
                            <div id="checklistItems" class="checklist-items">
                                <!-- チェックリスト項目が動的に生成される -->
                            </div>
                        </div>
                    </div>
                    <div class="rewrite-editor">
                        <div class="editor-toolbar">
                            <!-- 編集モード切り替えタブ -->
                            <div class="editor-mode-tabs">
                                <button class="mode-tab active" data-mode="visual" id="visualModeTab">
                                    <span class="material-icons-round">visibility</span>
                                    ビジュアル
                                </button>
                                <button class="mode-tab" data-mode="html" id="htmlModeTab">
                                    <span class="material-icons-round">code</span>
                                    HTML
                                </button>
                            </div>
                            <div style="flex: 1;"></div>
                            <button class="toolbar-btn" data-action="export" id="rewriteExportBtn" style="background: white; color: var(--text-primary); border-color: var(--border-color);">
                                <span class="material-icons-round">download</span>
                                エクスポート
                            </button>
                            <button class="toolbar-btn" data-action="save">
                                <span class="material-icons-round">save</span>
                                保存して完了
                            </button>
                        </div>
                        <!-- ビジュアルモード（Quill Rich Text Editor） -->
                        <div id="visualEditorContainer" class="editor-mode-container active">
                            <div id="quillEditor" style="background: white; border-radius: 8px;"></div>
                        </div>
                        <!-- HTMLモード（テキストエディタ） -->
                        <div id="htmlEditorContainer" class="editor-mode-container" style="display: none;">
                            <textarea id="htmlEditor" class="html-editor" placeholder="HTML形式で記事を編集してください..."></textarea>
                        </div>
                        <!-- Hidden textarea for storing content -->
                        <textarea id="markdownEditor" style="display: none;"></textarea>
                    </div>
                </div>
                <div id="aiGuidance" class="ai-guidance">
                    <h4><span class="material-icons-round">auto_awesome</span> AIサポート</h4>
                    <div id="aiGuidanceContent" class="ai-guidance-content">
                        左側のチェックリスト項目をクリックすると、ここに具体的な改善指示とAIのアドバイスが表示されます。
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- エクスポートモーダル -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>エクスポート</h2>
                <button class="modal-close" id="closeExportModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: #4b5563;">
                    記事を以下の形式でダウンロードできます。
                </p>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="export-option-btn" data-format="pdf">
                        <span class="material-icons-round">picture_as_pdf</span>
                        <div>
                            <div style="font-weight: 600;">PDF形式</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">PDFファイルとしてダウンロード</div>
                        </div>
                    </button>
                    <button class="export-option-btn" data-format="docx">
                        <span class="material-icons-round">description</span>
                        <div>
                            <div style="font-weight: 600;">Word形式 (.docx)</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Microsoft Wordで開ける形式</div>
                        </div>
                    </button>
                    <button class="export-option-btn" data-format="html">
                        <span class="material-icons-round">code</span>
                        <div>
                            <div style="font-weight: 600;">HTML形式</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Googleドキュメントにインポート可能</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- スクリプト -->
    <script src="js/data-manager.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/rewrite.js"></script>
    <script src="js/monitoring.js"></script>
    <script src="js/reporting.js"></script>
    
    <!-- 初期化 -->
    <script>
        // グローバル変数としてインスタンスを作成（windowオブジェクトに直接代入）
        window.dashboard = null;
        window.rewriteSystem = null;
        window.monitoringSystem = null;
        window.reportingSystem = null;

        // DOMContentLoaded後に初期化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 各システムを初期化
                window.dashboard = new Dashboard();
                window.rewriteSystem = new RewriteSystem();
                window.monitoringSystem = new MonitoringSystem();
                window.reportingSystem = new ReportingSystem();
                
                // 初期化を実行
                await window.rewriteSystem.init();
                await window.monitoringSystem.init();
                await window.reportingSystem.init();
                
                console.log('システムの初期化が完了しました');
            } catch (error) {
                console.error('システムの初期化エラー:', error);
            }
        });
    </script>
</body>
</html>
