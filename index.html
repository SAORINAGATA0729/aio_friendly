<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIO改修マネージャー</title>
    <link rel="stylesheet" href="/css/styles.css?v=1.0.4">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <!-- Quill.js for Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- docx.js for Word export - 動的インポートを使用 -->
    <!-- 注意: docx.jsはES6モジュール形式のため、グローバル変数として利用できません -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- ヘッダー -->
        <header class="app-header">
            <h1 class="app-title">
                <span class="material-icons-round">psychology</span>
                AIO改修マネージャー
            </h1>
            <div class="header-actions">
                <button id="backupBtn" class="btn btn-secondary">
                    <span class="material-icons-round">backup</span>
                    バックアップ
                </button>
                <button id="exportBtn" class="btn btn-secondary">
                    <span class="material-icons-round">download</span>
                    エクスポート
                </button>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="main-content">
            <!-- PDCAタブ -->
            <div class="pdca-tabs">
                <button class="pdca-tab active" data-tab="overview">
                    <span class="material-icons-round">dashboard</span>
                    Overview
                </button>
                <button class="pdca-tab" data-tab="plan">
                    <span class="material-icons-round">lightbulb</span>
                    Plan
                </button>
                <button class="pdca-tab" data-tab="do">
                    <span class="material-icons-round">edit</span>
                    Do
                </button>
                <button class="pdca-tab" data-tab="check">
                    <span class="material-icons-round">assessment</span>
                    Check
                </button>
                <button class="pdca-tab" data-tab="action">
                    <span class="material-icons-round">trending_up</span>
                    Action
                </button>
            </div>

            <!-- Overviewタブコンテンツ -->
            <div id="overviewTab" class="tab-content active">
                <h2>Overview <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">全体サマリー</span></h2>
                
                <!-- 現状把握カード -->
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="material-icons-round">search</span>
                            <h3>AIO引用数</h3>
                        </div>
                        <div class="card-body">
                            <div class="metric-value" id="aioCitationCount">857</div>
                            <div class="metric-label">件（目標: 1,200件以上）</div>
                            <div class="metric-change" id="aioCitationChange">+0件</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="material-icons-round">trending_up</span>
                            <h3>検索順位（Tier 1）</h3>
                        </div>
                        <div class="card-body">
                            <div class="metric-value" id="searchRankingAvg">4.88</div>
                            <div class="metric-label">位（目標: 5.0位以下）</div>
                            <div class="metric-change" id="searchRankingChange">±0位</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="material-icons-round">bar_chart</span>
                            <h3>トラフィック</h3>
                        </div>
                        <div class="card-body">
                            <div class="metric-value" id="trafficClicks">102,000</div>
                            <div class="metric-label">クリック数（12月）</div>
                            <div class="metric-change" id="trafficChange">+0件</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <span class="material-icons-round">visibility</span>
                            <h3>ブランド認知度</h3>
                        </div>
                        <div class="card-body">
                            <div class="metric-value" id="brandClicks">22</div>
                            <div class="metric-label">クリック数（12月）</div>
                            <div class="metric-change" id="brandChange">+0件</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Planタブコンテンツ -->
            <div id="planTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Plan <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">プラン管理</span></h2>
                    <button id="createPlanBtn" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="material-icons-round">add</span>
                        プランを作成する
                    </button>
                </div>
                
                <!-- プラン一覧 -->
                <div id="plansList" class="plans-list">
                    <!-- プランカードが動的に追加される -->
                </div>
            </div>

            <!-- Doタブコンテンツ -->
            <div id="doTab" class="tab-content">
                <h2>Do <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">施策実行 & リライト</span></h2>
                
                <!-- プラン選択セクション -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: 0.75rem; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem;">どのプランで記事の改修を進めますか？</label>
                    <select id="selectedPlanId" style="width: 100%; max-width: 500px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-size: 0.9rem; background: white;">
                        <option value="">プランを選択してください</option>
                        <!-- プランが動的に追加される -->
                    </select>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                        <span class="material-icons-round" style="font-size: 14px; vertical-align: middle;">info</span>
                        プランを選択すると、そのプランで設定した記事URL一覧が表示されます。
                    </div>
                </div>
                
                <!-- 改修進捗状況 -->
                <div class="progress-section" style="background: #f8fafc; padding: 1.5rem 2rem; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; border-radius: 1rem; box-shadow: var(--shadow);">
                    <h3 style="margin: 0 0 1.5rem 0; font-size: 1.25rem; font-weight: 700; color: var(--text-primary);">改修進捗状況</h3>
                    <div class="progress-summary">
                        <div class="progress-item">
                            <span class="progress-label">完了</span>
                            <div style="display: flex; align-items: baseline;">
                                <span class="progress-value" id="progressCompleted">0</span>
                                <span class="progress-unit">本</span>
                            </div>
                        </div>
                        <div class="progress-item">
                            <span class="progress-label">進行中</span>
                            <div style="display: flex; align-items: baseline;">
                                <span class="progress-value" id="progressInProgress">0</span>
                                <span class="progress-unit">本</span>
                            </div>
                        </div>
                        <div class="progress-item">
                            <span class="progress-label">未着手</span>
                            <div style="display: flex; align-items: baseline;">
                                <span class="progress-value" id="progressNotStarted">20</span>
                                <span class="progress-unit">本</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 記事一覧 -->
                <div class="article-list-section">
                    <div class="section-header">
                        <h3>改修対象記事一覧</h3>
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">すべて</button>
                            <button class="filter-btn" data-filter="notStarted">未着手</button>
                            <button class="filter-btn" data-filter="inProgress">進行中</button>
                            <button class="filter-btn" data-filter="completed">完了</button>
                        </div>
                    </div>
                    <div id="articleList" class="article-list">
                        <!-- 記事カードが動的に生成される -->
                    </div>
                </div>
            </div>

            <!-- Checkタブコンテンツ -->
            <div id="checkTab" class="tab-content">
                <h2>Check <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">検証 & モニタリング</span></h2>
                
                <!-- モニタリングデータ入力 -->
                <div class="monitoring-section">
                    <h3>モニタリングデータ入力</h3>
                    <form id="monitoringForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="monitoringMonth">対象月</label>
                                <input type="month" id="monitoringMonth" class="form-input" required>
                            </div>
                        </div>

                        <div class="monitoring-category">
                            <h4><span class="material-icons-round">search</span> AIO引用数（Ahrefs）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Google AI Overview</label>
                                    <input type="number" class="form-input" data-metric="aio_google" placeholder="件数">
                                </div>
                                <div class="form-group">
                                    <label>ChatGPT</label>
                                    <input type="number" class="form-input" data-metric="aio_chatgpt" placeholder="件数">
                                </div>
                                <div class="form-group">
                                    <label>Perplexity</label>
                                    <input type="number" class="form-input" data-metric="aio_perplexity" placeholder="件数">
                                </div>
                            </div>
                        </div>

                        <div class="monitoring-category">
                            <h4><span class="material-icons-round">trending_up</span> 検索順位（Tier 1の20ページ）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>合計クリック数</label>
                                    <input type="number" class="form-input" data-metric="ranking_clicks" placeholder="クリック数">
                                </div>
                                <div class="form-group">
                                    <label>平均掲載順位</label>
                                    <input type="number" step="0.01" class="form-input" data-metric="ranking_position" placeholder="順位">
                                </div>
                            </div>
                        </div>

                        <div class="monitoring-category">
                            <h4><span class="material-icons-round">bar_chart</span> トラフィック分析（全体）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>総クリック数</label>
                                    <input type="number" class="form-input" data-metric="traffic_clicks" placeholder="クリック数">
                                </div>
                                <div class="form-group">
                                    <label>平均CTR</label>
                                    <input type="number" step="0.01" class="form-input" data-metric="traffic_ctr" placeholder="%">
                                </div>
                            </div>
                        </div>

                        <div class="monitoring-category">
                            <h4><span class="material-icons-round">visibility</span> ブランド認知度（指名検索）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>合計クリック数</label>
                                    <input type="number" class="form-input" data-metric="brand_clicks" placeholder="クリック数">
                                </div>
                                <div class="form-group">
                                    <label>平均順位</label>
                                    <input type="number" step="0.01" class="form-input" data-metric="brand_position" placeholder="順位">
                                </div>
                            </div>
                        </div>

                        <div style="text-align: right;">
                            <button type="submit" class="btn btn-primary">
                                <span class="material-icons-round">save</span>
                                データを保存
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 前後比較グラフ -->
                <div class="comparison-section">
                    <h3>前後比較グラフ</h3>
                    <div class="chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Actionタブコンテンツ -->
            <div id="actionTab" class="tab-content">
                <h2>Action <span style="font-size: 1rem; color: #6b7280; font-weight: 500; margin-left: 10px;">振り返り & レポート</span></h2>
                
                <!-- 効果測定結果 -->
                <div class="results-section">
                    <h3>効果測定結果</h3>
                    <div id="resultsSummary" class="results-summary">
                        <!-- 結果が動的に生成される -->
                    </div>
                </div>

                <!-- 改善提案 -->
                <div class="improvement-section">
                    <h3>改善提案</h3>
                    <form id="improvementForm">
                        <div class="form-group">
                            <label for="improvementTitle">改善タイトル</label>
                            <input type="text" id="improvementTitle" class="form-input" placeholder="例: 表の活用を増やす">
                        </div>
                        <div class="form-group">
                            <label for="improvementDescription">改善内容</label>
                            <textarea id="improvementDescription" class="form-textarea" rows="5" placeholder="具体的な改善内容を記述してください"></textarea>
                        </div>
                        <div style="text-align: right;">
                            <button type="submit" class="btn btn-primary">
                                <span class="material-icons-round">save</span>
                                改善提案を保存
                            </button>
                        </div>
                    </form>
                </div>

                <!-- レポート生成 -->
                <div class="report-section">
                    <h3>レポート生成</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="generateReportBtn" class="btn btn-primary">
                            <span class="material-icons-round">description</span>
                            レポートを生成
                        </button>
                        <button id="exportPdfBtn" class="btn btn-secondary" style="color: var(--text-primary);">
                            <span class="material-icons-round">picture_as_pdf</span>
                            PDFでダウンロード
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- URL入力モーダル -->
    <div id="urlModal" class="modal">
        <div class="modal-content" style="max-width: 600px; height: auto;">
            <div class="modal-header">
                <h2>記事URLを入力</h2>
                <button class="modal-close" id="closeUrlModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="url-input-container">
                    <p style="margin-bottom: 1rem; color: #4b5563;">
                        編集する記事のURLを確認してください。
                    </p>
                    <div class="url-input-group">
                        <input type="text" id="articleUrlInput" class="form-input" placeholder="https://giftee.biz/columns/..." readonly>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px;">
                        <!-- 保存済みボタンは動的に追加される -->
                        
                        <!-- 自動取得ボタン -->
                        <button id="autoFetchBtn" class="btn btn-primary" style="padding: 1rem; font-size: 1.1rem; justify-content: center; background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);">
                            <span class="material-icons-round">auto_fix_high</span>
                            記事内容を自動取得して編集
                        </button>
                        
                        <!-- 「または」のdiv（保存済みがない場合は非表示） -->
                        <div class="or-divider" style="position: relative; text-align: center; margin: 10px 0; display: none;">
                            <span style="background: #f8fafc; padding: 0 10px; color: #6b7280; font-size: 0.9rem; position: relative; z-index: 1;">または</span>
                            <div style="position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #e5e7eb; z-index: 0;"></div>
                        </div>

                        <!-- 手動用ボタン（非表示にする） -->
                        <div style="display: none;">
                            <button id="openUrlBtn" class="btn btn-secondary" style="flex: 1; color: var(--text-primary); border-color: var(--border-color); background: white;">
                                <span class="material-icons-round">open_in_new</span>
                                ブラウザで開く
                            </button>
                            <button id="proceedToEditorBtn" class="btn btn-secondary" style="flex: 1; color: var(--text-primary); border-color: var(--border-color); background: white;">
                                <span class="material-icons-round">edit_note</span>
                                空のエディタを開く
                            </button>
                        </div>
                    </div>

                    <div id="fetchStatus" style="margin-top: 15px; font-size: 0.9rem; min-height: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- プラン作成/編集モーダル -->
    <div id="planModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="planModalTitle">プランを作成</h2>
                <button class="modal-close" id="closePlanModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="planForm">
                    <!-- プラン名 -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">プラン名 *</label>
                        <input type="text" id="planName" required 
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="例: Tier 1 記事改修プラン">
                    </div>
                    
                    <!-- 目的 -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">目的 *</label>
                        <textarea id="planObjective" required rows="3"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="このプランの目的を記入してください"></textarea>
                    </div>
                    
                    <!-- 概要 -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">概要</label>
                        <textarea id="planOverview" rows="4"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="プランの概要を記入してください"></textarea>
                    </div>
                    
                    <!-- 次のステップ -->
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">次のステップ</label>
                        <textarea id="planNextSteps" rows="3"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="次のステップを記入してください"></textarea>
                    </div>
                    
                    <!-- 数値入力セクション -->
                    <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-primary);">数値入力（Ahrefs等）</h3>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <!-- CSVインポートボタン -->
                                <button type="button" id="importCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                    CSVからインポート
                                </button>
                                <!-- MDインポートボタン -->
                                <button type="button" id="importMdMetricsBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">description</span>
                                    MDからインポート
                                </button>
                                <!-- CSVエクスポートボタン（テンプレートダウンロード用） -->
                                <button type="button" id="exportCsvTemplateBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">download</span>
                                    テンプレート
                                </button>
                            </div>
                        </div>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        <input type="file" id="mdMetricsFileInput" accept=".md,.txt" style="display: none;">
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; flex-direction: column;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">AIO引用数</label>
                                <input type="number" id="planAioCitations" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="857">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="planAvgRanking" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="4.88">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">トラフィック（クリック数）</label>
                                <input type="number" id="planTraffic" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="102000">
                            </div>
                            <div style="display: flex; flex-direction: column;">
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">ブランド認知度</label>
                                <input type="number" id="planBrandClicks" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="22">
                            </div>
                        </div>
                        
                        
                        <!-- 記事ごとの数値入力テーブル -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: white; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="margin: 0; font-size: 1rem; color: var(--text-primary);">記事ごとの数値入力</h4>
                                <div style="display: flex; gap: 0.5rem;">
                                    <!-- CSVインポートボタン -->
                                    <button type="button" id="importArticleMetricsCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                        <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                        CSVからインポート
                                    </button>
                                    <!-- MDインポートボタン -->
                                    <button type="button" id="importArticleMetricsMdBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                        <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">description</span>
                                        MDからインポート
                                    </button>
                                    <button type="button" id="addArticleRowBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                        <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">add</span>
                                        記事を追加
                                    </button>
                                </div>
                            </div>
                            <input type="file" id="articleMetricsCsvFileInput" accept=".csv" style="display: none;">
                            <input type="file" id="articleMetricsMdFileInput" accept=".md,.txt" style="display: none;">
                            <div style="overflow-x: auto;">
                                <table id="articleMetricsTable" style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                                    <thead>
                                        <tr style="background: #f9fafb; border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: #374151;">記事名/URL</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">クリック数</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">表示回数</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">CTR (%)</th>
                                            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: #374151;">順位</th>
                                            <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: #374151;">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="articleMetricsBody">
                                        <!-- 動的に追加される -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- API連携ボタン（将来実装用） -->
                        <button type="button" id="connectAhrefsBtn" class="btn btn-secondary" 
                            style="width: 100%; margin-top: 0.5rem; opacity: 0.6; cursor: not-allowed;"
                            disabled title="Ahrefs API連携は今後実装予定">
                            <span class="material-icons-round" style="margin-right: 4px;">link</span>
                            Ahrefs API連携（今後実装予定）
                        </button>
                    </div>
                    
                    <!-- 記事URL一覧 -->
                    <div style="margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <label style="display: block; font-weight: 600;">記事URL一覧</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <!-- CSVインポートボタン -->
                                <button type="button" id="importUrlsCsvBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">upload_file</span>
                                    CSVからインポート
                                </button>
                                <!-- MDインポートボタン -->
                                <button type="button" id="importUrlsMdBtn" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">
                                    <span class="material-icons-round" style="font-size: 18px; margin-right: 4px;">description</span>
                                    MDからインポート
                                </button>
                            </div>
                        </div>
                        <textarea id="articleUrlsTextarea" rows="8" 
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; font-family: monospace; font-size: 0.9rem; resize: vertical;"
                            placeholder="記事URLを1行に1つずつ入力してください&#10;例：&#10;https://example.com/article1&#10;https://example.com/article2&#10;https://example.com/article3"></textarea>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                            <span class="material-icons-round" style="font-size: 14px; vertical-align: middle;">info</span>
                            1行に1つのURLを入力してください。空行は無視されます。<strong>CSV/MDファイルからもインポート可能です。</strong>
                        </div>
                        <input type="file" id="urlsCsvFileInput" accept=".csv" style="display: none;">
                        <input type="file" id="urlsMdFileInput" accept=".md,.txt" style="display: none;">
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" id="cancelPlanBtn" class="btn btn-secondary">キャンセル</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ベースライン編集モーダル -->
    <div id="baselineModal" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>ベースライン設定（2025年12月実績）</h2>
                <button class="modal-close" id="closeBaselineModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="baselineForm">
                    <!-- 数値入力 -->
                    <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 1rem; font-size: 1.1rem; color: var(--text-primary);">全体数値</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">AIO引用数</label>
                                <input type="number" id="baselineAioCitations" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="857">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="baselineAvgRanking" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="4.88">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">トラフィック（クリック数）</label>
                                <input type="number" id="baselineTraffic" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="102000">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">ブランド認知度</label>
                                <input type="number" id="baselineBrandClicks" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;"
                                    placeholder="22">
                            </div>
                        </div>
                    </div>

                    <!-- Tier 1記事詳細データ入力 -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem; font-size: 1.1rem; color: var(--text-primary);">Tier 1記事詳細データ</h3>
                        <div id="tier1ArticlesInputContainer" style="overflow-x: auto;">
                            <!-- テーブルが動的に生成される -->
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('baselineModal').classList.remove('active')">キャンセル</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- エビデンス追加モーダル -->
    <div id="evidenceModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>月次データを追加</h2>
                <button class="modal-close" onclick="document.getElementById('evidenceModal').classList.remove('active')">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="evidenceForm">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">対象月</label>
                        <input type="month" id="evidenceMonth" required
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;">
                    </div>

                    <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                        <h3 style="margin: 0 0 1rem; font-size: 1.1rem; color: var(--text-primary);">実績数値</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">AIO引用数</label>
                                <input type="number" id="evidenceAioCitations" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">検索順位（平均）</label>
                                <input type="number" step="0.01" id="evidenceAvgRanking" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">トラフィック</label>
                                <input type="number" id="evidenceTraffic" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">ブランド認知度</label>
                                <input type="number" id="evidenceBrandClicks" 
                                    style="width: 100%; padding: 0.6rem; border: 1px solid var(--border-color); border-radius: 0.4rem;">
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">備考</label>
                        <textarea id="evidenceNotes" rows="3"
                            style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem;"
                            placeholder="特記事項があれば記入してください"></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('evidenceModal').classList.remove('active')">キャンセル</button>
                        <button type="button" class="btn btn-primary" onclick="dashboardSystem.saveEvidenceRecord()">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- リライトモーダル -->
    <div id="rewriteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="rewriteModalTitle">記事リライト</h2>
                <button class="modal-close" id="closeRewriteModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="rewrite-container">
                    <div class="rewrite-sidebar">
                        <!-- スコア表示エリア -->
                        <div id="checklistScore" class="checklist-score">
                            <div class="score-status">
                                <div class="score-main">
                                    <span class="score-label">現状</span>
                                    <span id="scoreNumber">0</span>
                                    <span class="score-unit">点</span>
                                    <span class="score-separator">/</span>
                                    <span class="score-total">100点</span>
                                </div>
                                <div class="score-rank-display">
                                    <span class="rank-label">RANK</span>
                                    <span id="scoreRank" class="rank-value">-</span>
                                </div>
                            </div>
                            <div class="score-progress">
                                <div class="score-bar">
                                    <div class="score-bar-fill" id="scoreBarFill" style="width: 0%"></div>
                                </div>
                                <div class="score-text">
                                    <span id="checkedCount">0</span> / <span id="totalCount">0</span> 項目
                                </div>
                            </div>
                        </div>
                        <div class="improvement-section">
                            <h4 class="improvement-title">改善項目</h4>
                            <div id="checklistItems" class="checklist-items">
                                <!-- チェックリスト項目が動的に生成される -->
                            </div>
                        </div>
                    </div>
                    <div class="rewrite-editor">
                        <div class="editor-toolbar">
                            <!-- 編集モード切り替えタブ -->
                            <div class="editor-mode-tabs">
                                <button class="mode-tab active" data-mode="visual" id="visualModeTab">
                                    <span class="material-icons-round">visibility</span>
                                    ビジュアル
                                </button>
                                <button class="mode-tab" data-mode="html" id="htmlModeTab">
                                    <span class="material-icons-round">code</span>
                                    HTML
                                </button>
                            </div>
                            <div style="flex: 1;"></div>
                            <!-- 検索バー -->
                            <div id="searchBar" class="search-bar" style="display: none;">
                                <input type="text" id="searchInput" class="search-input" placeholder="検索...">
                                <button id="searchPrevBtn" class="search-nav-btn" title="前へ">
                                    <span class="material-icons-round">arrow_upward</span>
                                </button>
                                <button id="searchNextBtn" class="search-nav-btn" title="次へ">
                                    <span class="material-icons-round">arrow_downward</span>
                                </button>
                                <span id="searchCount" class="search-count"></span>
                                <button id="searchCloseBtn" class="search-close-btn" title="閉じる">
                                    <span class="material-icons-round">close</span>
                                </button>
                            </div>
                            <button class="toolbar-btn" id="searchToggleBtn" title="検索 (⌘F)">
                                <span class="material-icons-round">search</span>
                                検索
                            </button>
                            <!-- プレビューボタンを追加 -->
                            <button class="toolbar-btn" id="previewBtn" title="プレビュー">
                                <span class="material-icons-round">preview</span>
                                プレビュー
                            </button>
                            <button class="toolbar-btn" data-action="export" id="rewriteExportBtn">
                                <span class="material-icons-round">download</span>
                                エクスポート
                            </button>
                            <button class="toolbar-btn" data-action="save">
                                <span class="material-icons-round">save</span>
                                保存して完了
                            </button>
                        </div>
                        <!-- ビジュアルモード（Quill Rich Text Editor） -->
                        <div id="visualEditorContainer" class="editor-mode-container active">
                            <div id="quillEditor" style="background: white; border-radius: 8px;"></div>
                        </div>
                        <!-- HTMLモード（テキストエディタ） -->
                        <div id="htmlEditorContainer" class="editor-mode-container">
                            <textarea id="htmlEditor" class="html-editor" placeholder="HTML形式で記事を編集してください..."></textarea>
                        </div>
                        <!-- Hidden textarea for storing content -->
                        <textarea id="markdownEditor" style="display: none;"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- エクスポートモーダル -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>エクスポート</h2>
                <button class="modal-close" id="closeExportModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: #4b5563;">
                    記事を以下の形式でダウンロードできます。
                </p>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <button class="export-option-btn" data-format="pdf">
                        <span class="material-icons-round">picture_as_pdf</span>
                        <div>
                            <div style="font-weight: 600;">PDF形式</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">PDFファイルとしてダウンロード</div>
                        </div>
                    </button>
                    <button class="export-option-btn" data-format="docx">
                        <span class="material-icons-round">description</span>
                        <div>
                            <div style="font-weight: 600;">Word形式 (.docx)</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Microsoft Wordで開ける形式</div>
                        </div>
                    </button>
                    <button class="export-option-btn" data-format="html">
                        <span class="material-icons-round">code</span>
                        <div>
                            <div style="font-weight: 600;">HTML形式</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Googleドキュメントにインポート可能</div>
                        </div>
                    </button>
                    <button class="export-option-btn" data-format="md">
                        <span class="material-icons-round">article</span>
                        <div>
                            <div style="font-weight: 600;">Markdown形式 (.md)</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Markdownファイルとしてダウンロード</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- プレビューモーダル -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h2>プレビュー</h2>
                <button class="modal-close" id="closePreviewModal">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 2rem;">
                <div id="previewContent" style="
                    max-width: 800px;
                    margin: 0 auto;
                    background: white;
                    padding: 2rem;
                    border-radius: 8px;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    line-height: 1.8;
                    color: #1f2937;
                ">
                    <!-- プレビュー内容がここに表示されます -->
                </div>
            </div>
        </div>
    </div>

    <!-- スクリプト -->
    <script src="/js/data-manager.js?v=1.0.4"></script>
    <script src="/js/dashboard.js?v=1.0.4"></script>
    <script src="/js/rewrite.js?v=1.0.4" onerror="window.rewriteJsLoadError = true; console.error('❌ rewrite.jsの読み込みに失敗しました');"></script>
    <script src="/js/monitoring.js?v=1.0.4"></script>
    <script src="/js/reporting.js?v=1.0.4"></script>
    
    <!-- 初期化 -->
    <script>
        // #region agent log
        const cssLink = document.querySelector('link[href*="styles.css"]');
        const jsScripts = Array.from(document.querySelectorAll('script[src]')).map(s => s.src);
        fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:525',message:'Script loading check - Before DOMContentLoaded',data:{cssHref:cssLink?.href,jsScripts:jsScripts,Dashboard:typeof Dashboard,RewriteSystem:typeof RewriteSystem,MonitoringSystem:typeof MonitoringSystem,ReportingSystem:typeof ReportingSystem,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'A'})}).catch(()=>{});
        // #endregion
        
        // グローバル変数としてインスタンスを作成（windowオブジェクトに直接代入）
        window.dashboard = null;
        window.rewriteSystem = null;
        window.monitoringSystem = null;
        window.reportingSystem = null;

        // スクリプトが読み込まれるまで待つ関数
        async function waitForScripts(maxWaitTime = 10000) {
            const startTime = Date.now();
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:535',message:'waitForScripts: Starting wait',data:{maxWaitTime:maxWaitTime},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'B'})}).catch(()=>{});
            // #endregion
            
            while (Date.now() - startTime < maxWaitTime) {
                const elapsed = Date.now() - startTime;
                const DashboardDefined = typeof Dashboard !== 'undefined';
                const RewriteSystemDefined = typeof RewriteSystem !== 'undefined';
                const MonitoringSystemDefined = typeof MonitoringSystem !== 'undefined';
                const ReportingSystemDefined = typeof ReportingSystem !== 'undefined';
                
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:545',message:'waitForScripts: Checking script availability',data:{elapsed:elapsed,DashboardDefined:DashboardDefined,RewriteSystemDefined:RewriteSystemDefined,MonitoringSystemDefined:MonitoringSystemDefined,ReportingSystemDefined:ReportingSystemDefined,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'C'})}).catch(()=>{});
                // #endregion
                
                if (DashboardDefined && RewriteSystemDefined && MonitoringSystemDefined && ReportingSystemDefined) {
                    // #region agent log
                    fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:550',message:'waitForScripts: All scripts loaded',data:{elapsed:elapsed},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'D'})}).catch(()=>{});
                    // #endregion
                    console.log('✅ すべてのスクリプトが読み込まれました');
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // #region agent log
            fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:560',message:'waitForScripts: Timeout',data:{elapsed:Date.now()-startTime,DashboardDefined:typeof Dashboard !== 'undefined',RewriteSystemDefined:typeof RewriteSystem !== 'undefined',MonitoringSystemDefined:typeof MonitoringSystem !== 'undefined',ReportingSystemDefined:typeof ReportingSystem !== 'undefined',rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'E'})}).catch(()=>{});
            // #endregion
            return false;
        }

        // DOMContentLoaded後に初期化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:565',message:'DOMContentLoaded: Starting initialization',data:{Dashboard:typeof Dashboard,RewriteSystem:typeof RewriteSystem,MonitoringSystem:typeof MonitoringSystem,ReportingSystem:typeof ReportingSystem,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'F'})}).catch(()=>{});
                // #endregion
                
                console.log('システムの初期化を開始します...');
                
                // スクリプトが読み込まれるまで待つ
                console.log('スクリプトの読み込みを待機中...');
                const scriptsLoaded = await waitForScripts();
                
                // #region agent log
                fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:575',message:'DOMContentLoaded: After waitForScripts',data:{scriptsLoaded:scriptsLoaded,Dashboard:typeof Dashboard,RewriteSystem:typeof RewriteSystem,MonitoringSystem:typeof MonitoringSystem,ReportingSystem:typeof ReportingSystem,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'G'})}).catch(()=>{});
                // #endregion
                
                if (!scriptsLoaded) {
                    const missingScripts = [];
                    if (typeof Dashboard === 'undefined') missingScripts.push('Dashboard (js/dashboard.js)');
                    if (typeof RewriteSystem === 'undefined') missingScripts.push('RewriteSystem (js/rewrite.js)');
                    if (typeof MonitoringSystem === 'undefined') missingScripts.push('MonitoringSystem (js/monitoring.js)');
                    if (typeof ReportingSystem === 'undefined') missingScripts.push('ReportingSystem (js/reporting.js)');
                    
                    // #region agent log
                    fetch('http://127.0.0.1:7243/ingest/5e579a2f-9640-4462-b017-57a5ca31c061',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.html:585',message:'DOMContentLoaded: Scripts not loaded error',data:{missingScripts:missingScripts,rewriteJsLoadError:window.rewriteJsLoadError},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'H'})}).catch(()=>{});
                    // #endregion
                    
                    throw new Error('以下のスクリプトが読み込まれていません: ' + missingScripts.join(', '));
                }
                
                // 各システムのインスタンスを作成
                window.dashboard = new Dashboard();
                window.rewriteSystem = new RewriteSystem();
                window.monitoringSystem = new MonitoringSystem();
                window.reportingSystem = new ReportingSystem();
                
                // 初期化を順番に実行（rewriteSystemを先に初期化してからdashboardを初期化）
                console.log('RewriteSystemの初期化を開始...');
                await window.rewriteSystem.init();
                console.log('RewriteSystemの初期化が完了しました');
                
                console.log('Dashboardの初期化を待機中...');
                await window.dashboard.init();
                console.log('Dashboardの初期化が完了しました');
                
                console.log('MonitoringSystemの初期化を開始...');
                await window.monitoringSystem.init();
                console.log('MonitoringSystemの初期化が完了しました');
                
                console.log('ReportingSystemの初期化を開始...');
                await window.reportingSystem.init();
                console.log('ReportingSystemの初期化が完了しました');
                
                console.log('✅ すべてのシステムの初期化が完了しました');
            } catch (error) {
                console.error('❌ システムの初期化エラー:', error);
                alert('システムの初期化に失敗しました。ページをリロードしてください。\nエラー: ' + error.message);
            }
        });
    </script>
</body>
</html>
